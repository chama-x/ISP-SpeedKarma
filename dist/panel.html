<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SpeedKarma Panel</title>
    <link rel="stylesheet" href="styles/tokens.css" />
    <link rel="stylesheet" href="styles/components.css" />
  </head>
  <body>
    <main class="panel panel--tesla" role="dialog" aria-label="SpeedKarma Control Panel">
      <header class="panel-header">
        <div class="status" aria-live="polite">
          <div class="title">SpeedKarma</div>
          <div class="subtext" id="statusSub" aria-live="polite">Initializing…</div>
        </div>
        <div class="mode-controls">
          <label class="visually-hidden" for="modeSelect">Mode</label>
          <select id="modeSelect" class="btn" aria-label="Mode">
            <option value="Auto">Auto</option>
            <option value="Enabled">Enabled</option>
            <option value="Disabled">Disabled</option>
          </select>
        </div>
      </header>

      <section class="grid">
        <div id="toggle" class="tile toggle" role="button" tabindex="0" aria-pressed="false" data-on="false" data-phase="inactive" aria-live="polite">
          <div class="circle" aria-hidden="true">
            <div class="ring" aria-hidden="true"></div>
            <svg class="glyph" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <circle cx="12" cy="12" r="9" opacity=".4"/>
              <path d="M12 7v10"/>
            </svg>
          </div>
          <div class="metrics fade-number" id="metrics" aria-live="polite">Optimization: Disabled</div>
        </div>

        <div id="serversTile" class="tile" role="button" tabindex="0" aria-label="Servers">
          <div class="label">Servers</div>
          <div>Fastest server</div>
          <div class="subtext" style="margin-top:6px;">Auto-select best route</div>
        </div>

        <div id="insightsTile" class="tile" role="button" tabindex="0" aria-label="Insights" aria-live="polite">
          <div class="label">Insights</div>
          <div id="insightText" class="fade-number" aria-live="polite">No recent data</div>
        </div>
        <div id="boosterTile" class="tile" aria-label="Booster status" tabindex="0" aria-live="polite">
          <div class="label">Booster</div>
          <div id="boosterLine" class="fade-number" aria-live="polite">inactive</div>
          <div class="subtext" id="boosterSub" style="margin-top:6px;color:var(--muted)" aria-live="polite">—</div>
        </div>
        <div id="speedtestTile" class="tile" role="button" tabindex="0" aria-label="Run Speedtest" aria-live="polite">
          <div class="label">Speedtest</div>
          <div id="speedtestLine" class="fade-number" aria-live="polite">Tap to run full-bandwidth test</div>
          <div class="subtext" id="speedtestSub" style="margin-top:6px;color:var(--muted)" aria-live="polite">—</div>
        </div>
        <div id="disguiseTile" class="tile" role="button" tabindex="0" aria-label="Disguise Mode" aria-live="polite">
          <div class="label">Disguise</div>
          <div id="disguiseLine" class="fade-number" aria-live="polite">Off</div>
          <div class="subtext" id="disguiseSub" style="margin-top:6px;color:var(--muted)" aria-live="polite">Mimic speedtest.net headers for app traffic</div>
    </div>
      </section>

      <footer class="footer">
        <div class="subtext" style="align-self:center">Esc to close</div>
        <button id="quitBtn" class="btn">Quit</button>
      </footer>
      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </main>

    <script>
      const { invoke } = window.__TAURI__?.tauri || {};
      const { listen } = window.__TAURI__?.event || {};
      const appWindow = window.__TAURI__?.window?.appWindow || null;
      const $ = (s)=>document.querySelector(s);
      const onKey = (el, handler)=>{
        el.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); handler(); }
        });
      };

      // Animate panel in on mount
      requestAnimationFrame(()=>{
        document.querySelector('.panel')?.classList.add('is-visible');
      });

      const toast = document.getElementById('toast');
      let toastTimer = null;
      function showToast(msg){
        toast.textContent = msg;
        toast.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(()=> toast.classList.remove('show'), 1800);
      }
      function updateNumber(el, text){
        if(!el) return;
        if(el.textContent === text) return;
        // Only animate for significant metric deltas
        el.classList.add('is-updating');
        el.textContent = text;
        setTimeout(()=> el.classList.remove('is-updating'), 140);
      }

      async function refresh(){
        if(!invoke){ return; }
        const st = await invoke("get_optimization_state").catch(()=>({ mode: "Disabled", text:"Learning patterns" }));
        const status = await invoke("get_system_status").catch(()=>null);
        const enabled = st.mode === "Enabled";
        const toggle = document.getElementById('toggle');
        toggle.dataset.on = String(enabled);
        toggle.setAttribute('aria-pressed', String(enabled));
        let metrics = "Optimization: Disabled";
        let sub = st.text ?? "Monitoring";
        if (enabled && status && status.effectiveness) {
          const eff = status.effectiveness;
          metrics = `Optimization: Enabled — ${eff.improvement_factor.toFixed(1)}×`;
          sub = `Baseline ${eff.baseline_speed.toFixed(1)} Mbps → ${eff.optimized_speed.toFixed(1)} Mbps`;
          updateNumber(document.getElementById('insightText'), `${Math.round(eff.confidence*100)}% confidence · Updated just now`);
        } else if (!enabled && status && status.data_collection_progress) {
          const p = status.data_collection_progress;
          metrics = `Optimization: Disabled — Learning ${p.days_collected}/${p.days_needed} days`;
          updateNumber(document.getElementById('insightText'), `Learning… ${p.progress_percentage.toFixed(0)}%`);
        } else {
          updateNumber(document.getElementById('insightText'), `No recent data`);
        }
        updateNumber(document.getElementById('metrics'), metrics);
        document.getElementById('statusSub').textContent = sub;
        const modeSelect = document.getElementById('modeSelect');
        if(modeSelect){
          const auto = await invoke("get_config").then(cfg => cfg.auto_optimization?.enabled).catch(()=>true);
          modeSelect.value = auto ? 'Auto' : (enabled ? 'Enabled' : 'Disabled');
        }
      }
      const handleToggle = async ()=>{ if(!invoke) return; await invoke("toggle_optimization"); await refresh(); showToast('Toggled optimization'); };
      document.getElementById('toggle').addEventListener('click', handleToggle);
      onKey(document.getElementById('toggle'), handleToggle);
      document.getElementById('speedtestTile').addEventListener('click', ()=> invoke && invoke('run_speedtest_once'));
      document.getElementById('disguiseTile').addEventListener('click', async ()=>{
        if(!invoke) return; const on = document.getElementById('disguiseLine').textContent !== 'On';
        await invoke('set_disguise_mode', { enabled: on });
        updateNumber(document.getElementById('disguiseLine'), on ? 'On' : 'Off');
        showToast(`Disguise ${on ? 'enabled' : 'disabled'}`);
      });
      document.getElementById('quitBtn').addEventListener('click', ()=> invoke && invoke('quit_app'));
      const modeSelect = document.getElementById('modeSelect');
      if(modeSelect){
        modeSelect.addEventListener('change', async (e)=>{
          const val = e.target.value;
          if(val === 'Auto'){
            await invoke('set_auto_mode', { enabled: true });
          } else {
            await invoke('set_auto_mode', { enabled: false });
            await invoke('set_optimization_mode', { mode: val });
          }
          await refresh();
          showToast(`Mode: ${val}`);
        });
      }
      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && appWindow){ appWindow.hide(); }
      });
      if(listen){
        listen('optimization_progress', ({ payload })=>{
          const t = document.getElementById('toggle');
          if(!payload || !t) return;
          const phase = payload.phase || 'inactive';
          t.dataset.phase = String(phase);
          t.style.setProperty('--progress', (payload.phase_percent || 0));
          if(phase === 'optimizing'){ t.style.setProperty('--progress', 100); }
          const down = (payload.metrics?.down_mbps ?? 0).toFixed(1);
          const up = (payload.metrics?.up_mbps ?? 0).toFixed(1);
          const insight = `${down}↓  ${up}↑  · next switch ${payload.next_rotation_s}s`;
          updateNumber(document.getElementById('insightText'), insight);
          if(payload.metrics?.improvement){
            updateNumber(document.getElementById('metrics'), `Optimization: Enabled — ${payload.metrics.improvement.toFixed(1)}×`);
          }
        });
        listen('keeper_progress', ({ payload })=>{
          const next = payload?.next_burst_in_s ?? 0;
          const kb = payload?.last_burst_kb ?? 0;
          const used = payload?.hour_used_mb ?? 0;
          const budget = payload?.hour_budget_mb ?? 0;
          const cadence = (payload?.cadence || 'suspended');
          updateNumber(document.getElementById('boosterLine'), (kb>0 && next>0) ? `pulses ${next}s · ${kb} KB · next ${next}s` : `pulses paused`);
          const sub = `used ${used.toFixed(2)} / ${budget.toFixed(0)} MB/hr · ${cadence}`;
          document.getElementById('boosterSub').textContent = sub;
        });
        listen('speedtest_progress', ({ payload })=>{
          const phase = payload?.phase || 'idle';
          const t = payload?.elapsed_s || 0;
          updateNumber(document.getElementById('speedtestLine'), phase === 'done' ? 'Completed' : `${phase}… ${t}s`);
          document.getElementById('speedtestSub').textContent = 'Running at full bandwidth';
        });
      }
      refresh();
    </script>
  </body>
  </html>
